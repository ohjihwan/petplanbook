<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MY030</title>
    <link rel="stylesheet" href="/assets/css/swiper.css" />
    <link rel="stylesheet" href="/assets/css/common-ui.css" />
    <link rel="stylesheet" href="/assets/css/style.css" />
  </head>
  <body>
    <div class="page">
      <div class="container">
        <header class="header">
          <!-- header.html 로 페이지 통합 관리 -->
        </header>

        <main class="contents">
          <div class="content">
            <section class="main-banner">
              <figure class="img-box">
                <img src="/assets/imgs/img/img-MY010-3.jpg" alt="" />
              </figure>
              <div class="text-box">
                <h2 class="title">내 글 보기</h2>
                <p class="txt">내가 쓴 글을 모아서 보세요</p>
                <div class="guide-arrow" aria-label="하단에 컨텐츠가 있습니다">
                  <i></i>
                  <i></i>
                </div>
              </div>
            </section>

            <section class="list-content-area">
              <div class="inner">
                <div class="title-box">
                  <h2 class="title">마이루트</h2>
                  <p class="txt">나의 글을 모아서 보세요</p>
                </div>

                <div class="result-empty">
                  <p>아직 글이 없어요</p>
                </div>

                <div class="list-content -inner-type">
                  <ul class="lists" id="place-list">
                    <!-- JS로 항목이 채워질 자리 -->
                  </ul>
                </div>
              </div>
            </section>
          </div>
        </main>

        <footer class="footer">
          <!-- footer.html 로 페이지 통합 관리 -->
        </footer>
      </div>
    </div>

    <div id="login-modal" class="modal -login-modal"></div>

    <script src="/assets/libs/jquery/jquery-3.6.0.min.js"></script>
    <script src="/assets/libs/jquery-ui/jquery-ui.min.js"></script>
    <script src="/assets/libs/jquery-ui/jquery.ui.touch-punch.min.js"></script>
    <script src="/assets/libs/swiper/dist/js/swiper.min.js"></script>
    <script src="/assets/js/style.js"></script>
    <script src="/assets/js/dev.js"></script>

    <script>
      document
        .getElementById("placeForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const res = await fetch("http://localhost:8080/places", {
            method: "POST",
            body: formData,
          });
          const result = await res.json();
          alert(result.message);
          loadPlaces();
        });

      async function loadPlaces() {
        const res = await fetch("http://localhost:8080/places");
        const places = await res.json();

        const listDiv = document.getElementById("place-list");
        if (places.length === 0) {
          document.querySelector(".result-empty").style.display = "block";
        } else {
          document.querySelector(".result-empty").style.display = "none";
        }

        listDiv.innerHTML = places
          .map(
            (place) => `
            <li class="unit">
                <a href="../MY/MY020.html">
                    <figure class="img-box">
                        <img src="http://localhost:8080${
                          place.image_url
                        }" alt="">
                    </figure>
                    <div class="txts">
                        <h3 class="main-txt">${place.name}</h3>
                        <p class="sub-txt -ellipsis-2">${place.description}</p>
                        <div class="info">
                            <span class="date">작성일: <strong>${new Date(
                              place.created_at
                            ).toLocaleDateString()}</strong></span>
                        </div>
                    </div>
                </a>
                <button onclick="deletePlace(${place.id})">삭제</button>
                <button onclick="editPlace(${place.id})">수정</button>
            </li>
        `
          )
          .join("");
      }

      async function deletePlace(id) {
        if (!confirm("정말 삭제하시겠습니까?")) return;
        const res = await fetch(`http://localhost:8080/places/${id}`, {
          method: "DELETE",
        });
        const result = await res.json();
        alert(result.message);
        loadPlaces();
      }

      async function editPlace(id) {
        const newName = prompt("새 이름을 입력하세요:");
        const newCategory = prompt("새 카테고리를 입력하세요:");
        const newAddress = prompt("새 주소를 입력하세요:");
        const newDescription = prompt("새 설명을 입력하세요:");
        if (!newName || !newCategory || !newAddress || !newDescription) return;
        const res = await fetch(`http://localhost:8080/places/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name: newName,
            category: newCategory,
            address: newAddress,
            description: newDescription,
          }),
        });
        const result = await res.json();
        alert(result.message);
        loadPlaces();
      }

      function renderPosts() {
        const posts = JSON.parse(localStorage.getItem("myPosts") || "[]");
        const listDiv = document.getElementById("place-list");
        if (!posts.length) {
          document.querySelector(".result-empty").style.display = "block";
        } else {
          document.querySelector(".result-empty").style.display = "none";
        }
        listDiv.innerHTML = posts
          .map(
            (post) => `
          <li class="unit">
            <div style="display:flex;align-items:flex-start;gap:16px;">
              ${
                post.imageUrl
                  ? `<img src="${post.imageUrl}" alt="썸네일" style="width:80px;height:60px;object-fit:cover;border-radius:6px;">`
                  : ""
              }
              <div>
                <h3 style="margin:0 0 8px 0;">${post.name}</h3>
                <div style="color:#555;font-size:0.95em;margin-bottom:4px;">${
                  post.description
                }</div>
                <div style="font-size:0.85em;color:#888;">${new Date(
                  post.createdAt
                ).toLocaleString()}</div>
              </div>
            </div>
          </li>
        `
          )
          .join("");
      }
      renderPosts();

      async function renderPlaces() {
        const res = await fetch("http://localhost:8080/place");
        const places = await res.json();
        const listDiv = document.getElementById("place-list");
        if (!places.length) {
          document.querySelector(".result-empty").style.display = "block";
        } else {
          document.querySelector(".result-empty").style.display = "none";
        }
        listDiv.innerHTML = places
          .map(
            (place) => `
          <li class="unit">
            <div style="display:flex;align-items:flex-start;gap:16px;">
              ${
                place.imageUrl
                  ? `<img src="http://localhost:8080${place.imageUrl}" alt="썸네일" style="width:80px;height:60px;object-fit:cover;border-radius:6px;">`
                  : ""
              }
              <div>
                <h3 style="margin:0 0 8px 0;">${place.name}</h3>
                <div style="color:#555;font-size:0.95em;margin-bottom:4px;">${
                  place.description
                }</div>
                <div style="font-size:0.85em;color:#888;">${new Date(
                  place.createdAt
                ).toLocaleString()}</div>
              </div>
            </div>
          </li>
        `
          )
          .join("");
      }
      renderPlaces();
    </script>
  </body>
</html>
