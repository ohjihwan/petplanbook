<!DOCTYPE html>
<html>
<head>
  <title>반려동물 동반 여행지</title>
  <style>
    .search-container {
      margin-bottom: 20px;
    }
    .category {
      font-size: 14px;
      font-weight: bold;
      padding: 3px 8px;
      border-radius: 5px;
      display: inline-block;
    }
    .category.lodging { background-color: #FFD700; color: #000; }
    .category.cafe { background-color: #FF6347; color: #fff; }
    .category.activity { background-color: #4CAF50; color: #fff; }
    .category.etc { background-color: #777; color: #fff; }
  </style>
</head>
<body>
  <h1>반려동물 동반 여행지</h1>
  <div class="search-container">
    <input type="text" id="search-input" placeholder="여행지 검색..." onkeydown="if(event.key === 'Enter') searchTravelList()" />
    <button onclick="searchTravelList()">검색</button>
  </div>

  <div class="filter-container">
    <label><input type="checkbox" class="category-checkbox" value="lodging"> 숙박</label>
    <label><input type="checkbox" class="category-checkbox" value="cafe"> 카페/음식점</label>
    <label><input type="checkbox" class="category-checkbox" value="activity"> 놀거리</label>
    <label><input type="checkbox" class="category-checkbox" value="etc"> 기타</label>


    
  </div>

  <div id="travel-list" style="display:none;">
    <ul>
        
    </ul>
  </div>
  <button id="load-more" style="display:none;" onclick="loadMore()">더보기</button>
  
  <script>
    let travelData = [];
    let filteredData = [];
    let currentPage = 1;
    const itemsPerPage = 8;

    async function fetchTravelList() {
      try {
        const listUrl = `https://apis.data.go.kr/B551011/KorPetTourService/areaBasedList?serviceKey=GTr1cI7Wi0FRbOTFBaUzUCzCDP4OnyyEmHnn11pxCUC5ehG5bQnbyztgeydnOWz1O04tjw1SE5RsX8RNo6XCgQ%3D%3D&numOfRows=1000&pageNo=1&MobileOS=ETC&MobileApp=AppTest&_type=json`;
        
        console.log("📡 브라우저에서 직접 API 요청:", listUrl);

        const apiResponse = await fetch(listUrl);
        const apiData = await apiResponse.json();
        console.log("✅ API 응답:", apiData);

        travelData = apiData.response?.body?.items?.item || [];
        filterAndDisplayList();
      } catch (error) {
        console.error("❌ API 요청 에러:", error.message);
        document.getElementById("travel-list").style.display = "block";
        document.getElementById("travel-list").innerHTML = "<ul><li>API 요청 중 오류가 발생했습니다.</li></ul>";
      }
    }

    // 검색 기능 (검색 버튼 클릭 시에만)
    function searchTravelList() {
      if (!document.getElementById("search-input").value.trim()) {
        alert("검색어를 입력하세요.");
        return;
      }

      travelData = [];
      filteredData = [];
      currentPage = 1;
      document.getElementById("travel-list").style.display = "none";
      document.getElementById("load-more").style.display = "none";
      fetchTravelList();
    }

    // 검색어와 카테고리 필터링 (검색 버튼 클릭 시에만)
    function filterAndDisplayList() {
      const searchText = document.getElementById("search-input").value.trim().toLowerCase();
      const selectedCategories = Array.from(document.querySelectorAll(".category-checkbox:checked"))
        .map(checkbox => checkbox.value);

      filteredData = travelData.filter(item => {
        const matchesText = item.title.toLowerCase().includes(searchText);
        const matchesCategory = selectedCategories.length === 0 || selectedCategories.includes(getCategoryType(item));
        return matchesText && matchesCategory;
      });

      sortByTopReadCount();
      displayTravelList();
    }

    // 조회수 높은 항목을 첫 번째로 배치 (하나만)
    function sortByTopReadCount() {
      if (filteredData.length === 0) return;

      const maxReadItem = filteredData.reduce((max, item) => 
        item.readcount > (max.readcount || 0) ? item : max, {});

      if (maxReadItem.readcount > 0) {
        filteredData = filteredData.filter(item => item !== maxReadItem);
        filteredData.unshift(maxReadItem);
      }
    }

    // 여행지 목록 표시 (최대 8개씩)
    function displayTravelList() {
      const list = document.getElementById("travel-list");
      list.innerHTML = "<ul></ul>";
      list.style.display = "block";
      const ul = list.querySelector("ul");

      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const displayItems = filteredData.slice(0, end);

      if (displayItems.length > 0) {
        displayItems.forEach(item => {
          const li = document.createElement("li");
          li.innerHTML = `
            <a href="javascript:void(0)" role="button" onclick="modalOpenId('detail')">
              <div class="img-box">
                <div class="flags">
                  <div class="category ${getCategoryType(item)}">${getCategory(item)}</div>
                </div>
                <img src="${item.firstimage || 'https://dummyimage.com/200x200/cccccc/ffffff&text=No+Image'}" alt="${item.title}">
              </div>
              <div class="txts">
                <strong class="main-txt">${item.title}</strong>
                <span class="sub-txt">${item.addr1 || '주소 정보 없음'}</span>
              </div>
            </a>
          `;
          ul.appendChild(li);
        });

        document.getElementById("load-more").style.display = displayItems.length >= itemsPerPage && end < filteredData.length ? "block" : "none";
      } else {
        ul.innerHTML = "<li>검색 결과가 없습니다.</li>";
        document.getElementById("load-more").style.display = "none";
      }

      // 노출된 li 수 콘솔에 출력
      console.log(`📊 노출된 아이템 수: ${ul.querySelectorAll("li").length} / ${filteredData.length}`);
    }

    // 다음 페이지 로드
    function loadMore() {
      currentPage++;
      displayTravelList();
    }

    // 카테고리 구분 함수
    function getCategoryType(item) {
      const type = item.contenttypeid;
      if (type === "32") return "lodging";
      if (type === "39") return "cafe";
      if (type === "12" || type === "28") return "activity";
      return "etc";
    }

    function getCategory(item) {
      const type = getCategoryType(item);
      if (type === "lodging") return "🏨 숙박";
      if (type === "cafe") return "☕ 카페 / 음식점";
      if (type === "activity") return "🎢 놀거리";
      return "📌 기타";
    }
</script>

</body>
</html>
